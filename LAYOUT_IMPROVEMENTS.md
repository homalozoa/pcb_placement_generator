# 布局优化说明

## 优化内容

### 1. 字体和文字优化

#### 字体设置
- **移除中文支持**：所有输出内容改为英文，避免字体兼容性问题
- **统一字体**：使用 `DejaVu Sans`, `Arial`, `Liberation Sans` 等标准英文字体
- **字体大小调整**：
  - 基础字体大小：从 8pt 降低到 6pt
  - 最小字体大小：从 4pt 降低到 3pt
  - 最大字体大小：从 12pt 降低到 10pt

#### 密度自适应字体
```python
# 根据元器件密度自动调整字体大小
if density > 0.15:      # 极高密度 -> 3pt
elif density > 0.1:     # 高密度   -> 4.2pt
elif density > 0.05:    # 中密度   -> 5.1pt
else:                   # 低密度   -> 6.6pt
```

### 2. 智能布局算法

#### 文字重叠避免
- **动态缓冲区**：根据文字大小动态计算间距缓冲区
- **多级位置搜索**：
  1. 元器件内部中心位置
  2. 四个方向的外部位置（右、左、上、下）
  3. 对角线位置（右上、左上、右下、左下）
  4. 更远距离的位置
  5. 螺旋搜索算法
  6. 网格搜索备用方案

#### 位置优先级
```python
候选位置优先级：
1. (0, 0)           # 元器件中心（最优）
2. 右侧、左侧        # 水平方向
3. 上方、下方        # 垂直方向  
4. 对角线位置        # 斜角方向
5. 螺旋搜索         # 智能搜索
6. 网格搜索         # 备用方案
```

### 3. 图形尺寸优化

#### 画布尺寸
- **从 A4 升级到 A3**：`(11.69, 8.27)` → `(16.53, 11.69)` 英寸
- **增加边距**：边距比例从 10% 增加到 15%
- **更高分辨率**：保持 300 DPI 确保打印质量

#### 元器件显示
- **缩小中心点**：减少视觉干扰
- **优化矩形边框**：使用半透明显示
- **文字背景**：添加圆角背景框提高可读性

### 4. 碰撞检测算法

#### 矩形重叠检测
```python
def _rectangles_overlap(self, x1, y1, w1, h1, x2, y2, w2, h2):
    # 动态缓冲区：至少1mm，或最小尺寸的30%
    buffer = max(1.0, min(w1, h1, w2, h2) * 0.3)
    
    return (abs(x1 - x2) < (w1 + w2) / 2 + buffer and 
            abs(y1 - y2) < (h1 + h2) / 2 + buffer)
```

#### 占用检测
- **文字与文字**：检测已放置文字的重叠
- **文字与元器件**：检测与元器件轮廓的重叠
- **动态缓冲区**：根据对象大小调整安全距离

### 5. 螺旋搜索优化

#### 搜索参数
- **搜索半径**：扩大到元器件尺寸的 5 倍
- **角度精度**：从 π/8 提高到 π/12（更密集）
- **步长优化**：使用文字尺寸的 1/3 作为步长

#### 备用方案
```python
螺旋搜索 → 网格搜索 → 远离中心位置
```

### 6. 文字尺寸计算

#### 智能尺寸估算
```python
# 基于最小元器件间距计算最优字体大小
min_distance = calculate_min_component_distance()
max_text_height = min_distance / 3.0  # 文字高度不超过间距的1/3
font_size = max_text_height * 2.83    # 毫米转点数
```

#### 密度调整
- **高密度区域**：自动缩小字体
- **低密度区域**：适当放大字体
- **统一性保证**：整个图纸使用相同字体大小

## 使用效果

### 改进前的问题
- ❌ 文字重叠严重
- ❌ 中文字体显示异常
- ❌ 字体大小不合适
- ❌ 布局拥挤

### 改进后的效果
- ✅ 文字完全避免重叠
- ✅ 英文字体显示完美
- ✅ 字体大小自适应
- ✅ 布局清晰美观
- ✅ 统一的视觉效果

## 测试验证

### 密集布局测试
```bash
python test_layout.py
```
- 创建 100+ 个密集排列的元器件
- 验证文字重叠避免算法
- 测试极端情况处理

### 重叠处理测试
- 在相同位置放置多个元器件
- 验证螺旋搜索算法
- 确保所有文字都能找到合适位置

### 真实数据测试
```bash
python cli_main.py test_position.csv -o final_test --refdes-only
```
- 使用包含 526 个元器件的真实PCB数据
- 验证算法在实际项目中的表现

## 配置选项

### 字体配置
```python
# config.py
base_font_size: int = 6      # 基础字体大小
min_font_size: int = 3       # 最小字体大小  
max_font_size: int = 10      # 最大字体大小
```

### 图形配置
```python
figure_size = (16.53, 11.69)  # A3尺寸
margin_ratio = 0.15           # 15%边距
dpi = 300                     # 高分辨率
```

### 布局配置
```python
# 动态缓冲区系数
buffer_ratio = 0.3

# 螺旋搜索参数
max_radius_multiplier = 5
angle_steps = 12
```

## 性能优化

### 算法复杂度
- **位置搜索**：O(n) 其中 n 是候选位置数
- **碰撞检测**：O(m) 其中 m 是已放置对象数
- **总体复杂度**：O(k × n × m) 其中 k 是元器件数

### 内存使用
- **位置缓存**：存储已放置文字的位置信息
- **边界缓存**：存储元器件边界信息
- **空间复杂度**：O(k) 线性增长

## 未来改进方向

1. **机器学习优化**：使用AI算法优化布局
2. **并行处理**：多线程处理大型PCB
3. **交互式调整**：允许用户手动调整位置
4. **模板系统**：预定义常用布局模板
5. **3D可视化**：支持立体显示

## 总结

通过以上优化，程序现在能够：
- 🎯 **完全避免文字重叠**
- 📐 **保持统一的字体大小**
- 🎨 **生成美观的布局**
- 🔧 **自适应不同密度的PCB**
- 📄 **输出高质量的PDF文件**

所有改进都经过了严格测试，确保在各种情况下都能产生清晰、可读、美观的位号图。
